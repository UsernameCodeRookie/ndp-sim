# 事件驱动的架构模拟与推理调度的协同设计研究

## 论文概述

本论文介绍一个用于AI芯片性能建模的事件驱动架构模拟框架，并通过与LLM推理调度的协同设计（co-design）展示其在系统优化中的价值。论文强调模拟器和调度算法之间的相互反馈循环：模拟器精确评估调度算法的性能影响，调度算法驱动模拟器的优化方向。

**论文主题**：事件驱动架构模拟、推理调度、硬件-软件协同设计、性能建模与优化

**总字数**：约110,000字（含代码注释与案例分析）

## 核心创新点

1. **通用事件驱动模拟框架**：提出Port-Component-Connection-Pipeline-Stage五层抽象，支持快速的处理器/系统建模
2. **事件驱动执行模型**：使用优先级队列实现O(log E)的事件管理，自然适配硬件和软件调度的多层级控制
3. **硬件-软件协同设计方法**：建立从调度算法到硬件评估的反馈闭环，使模拟器和调度器相互优化
4. **完整的性能分析工具链**：支持从微架构级（指令级）到系统级（工作负载级）的多粒度性能评估

## 论文结构

本论文采用"基础 → 框架 → 应用 → 协同设计"的组织方式，展现模拟器和调度在系统设计中的相互驱动关系。

### 第一部分：基础理论（第一章）

#### 第一章：事件驱动模拟的理论基础与实现 (~25,000字)

**目的**：为硬件模拟和软件调度系统的设计奠定理论基础

**关键内容**：
- 事件驱动模拟的优势（速度、精确性、灵活性）
- 事件队列的数据结构与算法（优先级队列、O(log E)复杂度）
- EventScheduler的优先级管理（模拟多层级控制）
- 周期性事件的处理（TickingComponent）与异步事件的集成
- 时间同步与多时钟域处理（CPU、内存、调度的异步性）
- 性能监测与轨迹捕捉（支持调度算法的决策反馈）
- 与传统模拟器的比较分析

**教学价值**：理解为何事件驱动模型天然适配硬件-软件协同系统

### 第二部分：框架设计（第二章）

#### 第二章：通用架构建模框架的设计与实现 (~26,000字)

**目的**：建立可同时支持硬件模拟和调度系统模拟的通用框架

**核心组成**：
- **Port与通信接口**：最小通信抽象，支持硬件组件和软件模块的交互
- **Component体系设计**：统一的单位抽象（处理器单元、调度队列、缓存管理）
- **Connection与通信协议**：多种连接方式（Wire、Ready-Valid、Credit-based），支持背压和流控
- **流水线的建模与分析**：从硬件流水线到软件处理管道的统一视角
- **Stage设计的原则与实现**：流水线级的具体设计，支持硬件和调度决策点
- **系统集成与同步机制**：多层级组件的协调与信息反馈

**教学价值**：框架不仅支持硬件，也支持硬件-软件协同的性能评估

### 第三部分：应用与案例（第三章、第四章）

#### 第三章：Coral NPU处理器的建模与硬件-调度协同分析 (~29,500字)

**目的**：以实际处理器为例，展示模拟框架在硬件设计中的应用，为后续的调度优化奠定基础

**关键内容**：
- **处理器体系架构总览**：Coral NPU的整体设计与ISA支持（为调度提供的执行能力）
- **标量核心的指令流水线**：5级流水线与冒险检测（调度需要理解的硬件约束）
- **功能单元的设计与优化**：ALU、MLU、LSU的详细设计（调度的资源模型）
- **寄存器堆与冒险检测**：多端口设计与Scoreboard机制（调度的依赖追踪参考）
- **RVV向量执行引擎**：向量指令、Lane并行、性能分析（调度对向量资源的理解）
- **微体系结构的优化与扩展**：分支预测、缓存优化、能耗管理（硬件给予调度的选项）
- **标量与向量的集成设计**：GEMM案例演示7.6倍性能提升（调度优化的硬件基础）

**设计亮点**：突出硬件特性如何影响调度决策（如向量执行的优先级、缓存敏感性等）

#### 第四章：LLM推理调度的设计与硬件-调度协同优化 (~29,500字)

**目的**：展示推理调度系统如何在模拟器指导下进行优化，同时调度需求如何驱动硬件评估

**关键内容**：

**4.1 LLM推理系统的架构与硬件特性**
- Prefill和Decode阶段的执行特性（计算与访存模式不同）
- 推理调度器面临的硬件约束（寄存器压力、内存带宽、功耗限制）
- 模拟器在调度设计中的作用（快速评估不同调度策略的硬件影响）

**4.2 推理调度算法与硬件约束的协同设计**
- 优先级队列调度与硬件事件驱动的对应关系
- 动态批处理策略的硬件成本分析（缓存污染、流水线阻塞）
- 资源感知调度：调度器对硬件资源（计算、内存、带宽）的显式建模

**4.3 内存管理与KV缓存的协同优化**
- 分页机制的硬件实现与调度影响
- 缓存替换策略：模拟器评估不同策略的缓存行为
- 调度与缓存的协同：调度决策如何影响缓存局部性

**4.4 多用户并发调度的硬件-软件约束**
- 公平性与QoS目标在硬件资源竞争中的体现
- 延迟目标与系统吞吐量的权衡（通过模拟器精确评估）
- 硬件隔离机制对调度策略的影响

**4.5 性能模型与协同分析**
- 首令延迟（TTFT）和生成延迟（TBT）的硬件来源分析
- 系统规格分析：调度决策在硬件上的性能影响量化
- 模拟器驱动的调度验证与优化

**4.6 硬件资源利用优化：调度视角**
- 计算资源（ALU、向量单元）的调度平衡
- 内存带宽管理：调度对访存模式的优化
- 功耗管理与调度的交互（DVFS与调度QoS的协调）

**4.7 协同设计的实验评估**
- 调度算法的硬件性能评估（通过模拟器）
- 不同硬件配置下的调度适应性（模拟器快速迭代）
- 硬件优化对调度性能的反馈与改进

**设计亮点**：展示模拟器和调度形成的"反馈闭环"，调度驱动硬件评估，硬件性能指导调度优化

### 第五部分：协同设计总结（补充内容，可选）

#### 附录/补充：硬件-软件协同设计的系统方法
- 从硬件性能数据到调度约束的映射方法
- 调度优化对硬件的反馈需求
- 快速迭代的设计流程和工具链

## 文件目录结构

```
paper/
├── README.md (本文件：论文总览)
│
├── part1-foundations/ (基础理论)
│   └── chapter1-event-driven-simulation/ (~25,000字)
│       ├── README.md
│       ├── 1.1-事件驱动模拟的概念与优势.md
│       ├── 1.2-事件队列与调度算法.md
│       ├── 1.3-事件驱动执行的性能优化.md
│       ├── 1.4-时间同步与多时钟域.md
│       ├── 1.5-性能监测与轨迹捕捉.md
│       └── 1.6-与其他模拟框架的比较.md
│
├── part2-framework/ (框架设计)
│   └── chapter2-architecture-modeling/ (~26,000字)
│       ├── README.md
│       ├── 2.1-建模框架总体设计.md
│       ├── 2.2-Port与通信接口.md
│       ├── 2.3-Component体系设计.md
│       ├── 2.4-Connection与通信协议.md
│       ├── 2.5-流水线的建模与分析.md
│       ├── 2.6-Stage设计的原则与实现.md
│       └── 2.7-系统集成与同步机制.md
│
├── part3-applications/ (应用与案例)
│   ├── chapter3-coral-npu/ (~29,500字)
│   │   ├── README.md
│   │   ├── 3.1-处理器体系架构总览.md
│   │   ├── 3.2-标量核心的指令流水线.md
│   │   ├── 3.3-功能单元的设计与优化.md
│   │   ├── 3.4-寄存器堆与冒险检测.md
│   │   ├── 3.5-RVV向量执行引擎.md
│   │   ├── 3.6-微体系结构的优化与扩展.md
│   │   └── 3.7-标量与向量的集成设计与性能分析.md
│   │
│   └── chapter4-llm-inference-scheduling/ (~29,500字)
│       ├── README.md
│       ├── 4.1-LLM推理系统的架构与硬件特性.md
│       ├── 4.2-推理调度算法与硬件约束的协同设计.md
│       ├── 4.3-内存管理与KV缓存的协同优化.md
│       ├── 4.4-多用户并发调度的硬件约束.md
│       ├── 4.5-性能模型与协同分析.md
│       ├── 4.6-硬件资源利用优化-调度视角.md
│       └── 4.7-协同设计的实验评估.md
│
└── appendix/ (可选补充)
    └── codesign-methodology.md (硬件-软件协同设计方法论)
```

## 推荐阅读路径

### 快速通道（入门，~5小时）- 理解协同设计思想
1. 本README的"核心创新点"和"论文结构"概览
2. 第一章 1.1-1.2（事件驱动基础）
3. 第二章 2.1（框架设计概览）
4. 第三章 3.1（硬件架构）+ 第四章 4.1（推理系统）
5. 第四章 4.5（协同分析）

### 硬件优先通道（处理器设计，~10小时）
1. 第一章全部（理解事件驱动）
2. 第二章 2.1-2.3（框架基础）
3. 第三章全部（Coral NPU详解）
4. 第四章 4.1-4.2（理解调度对硬件的需求）

### 调度优先通道（推理系统设计，~10小时）
1. 第一章 1.1-1.2（事件驱动基础）
2. 第二章 2.1-2.4（框架与通信）
3. 第三章 3.1, 3.3, 3.6（理解硬件约束）
4. 第四章全部（推理调度详解）

### 协同设计深入通道（系统设计，~18小时）
1. 按顺序完整阅读第一章、第二章
2. 第三章全部（充分理解硬件特性）
3. 第四章全部（充分理解调度与硬件的相互作用）
4. 研究设计决策：关注每一个设计选择如何影响另一个领域
5. 对比硬件优化和调度优化的相对成本与收益

### 快速参考通道（查阅，灵活）
- 硬件细节：第三章各小节
- 调度算法：第四章 4.2, 4.4, 4.5
- 性能分析：第一章 1.5 + 第四章 4.5
- 协同设计原理：第二章 2.7 + 第四章 4.2, 4.7

## 关键性能数据速查

| 指标 | 数值 |
|-----|------|
| 标量RegisterFile | 32×32 bit，16读8写 |
| ALU延迟 | 1周期 |
| MLU乘法延迟 | 3-4周期 |
| MLU除法延迟 | 32-40周期 |
| LSU L1 Hit延迟 | 3-4周期 |
| 向量VLEN | 256/512 bits |
| 向量Lane数 | 8（for VLEN=256, SEW=32） |
| 向量加法延迟 | 1-2周期 |
| 向量乘法延迟 | 3-4周期 |
| GEMM标量性能 | 550周期（256×256×128） |
| GEMM向量性能 | 72周期（256×256×128） |
| **性能提升比** | **7.6倍** |

## 术语速查表

| 术语 | 解释 |
|-----|------|
| **Event** | 时间驱动的异步任务 |
| **EventScheduler** | 优先级队列，O(log E)管理 |
| **Port** | 组件通信接口（读/写/检查） |
| **Component** | 处理器模型基本单位 |
| **Connection** | 协议实现，连接两个Port |
| **Pipeline** | 包含多个Stage的流处理 |
| **Stage** | 流水线的单个阶段 |
| **RAW** | 读后写冒险（数据依赖） |
| **Scoreboard** | 寄存器忙碌标志跟踪 |
| **CPI** | 周期数/指令数 |
| **ILP** | 指令级并行度 |
| **VLEN** | 向量寄存器宽度 |
| **Lane** | 向量执行的并行单元 |
| **DVFS** | 动态电压频率调整 |

## 论文特色

1. **硬件-软件协同视角**：不仅介绍两个独立系统，更强调它们的相互作用和反馈循环
2. **理论与实践结合**：从事件驱动理论、框架设计到处理器、推理系统的完整实现
3. **多层级性能分析**：支持从微架构（指令级）到系统级（工作负载级）的评估
4. **快速迭代的设计方法**：模拟器支持硬件和软件的并行优化
5. **实际工业应用**：基于真实的Coral NPU和LLM推理场景

## 关键概念与协同设计观点

### 硬件-调度的相互作用

| 硬件方面 | 调度影响 | 反馈机制 |
|---------|--------|--------|
| **流水线深度** | 分支预测/冒险处理的复杂度 | 预测失败成本 → 调度转移风险 |
| **向量执行宽度** | 向量指令的并行度、寄存器压力 | Lane数 → 批处理粒度 |
| **缓存结构** | 工作集配置、局部性敏感性 | Miss率 → 访存调度策略 |
| **内存带宽** | 并发访存能力、批处理规模 | 带宽利用率 → 批大小选择 |
| **功耗模型** | QoS和吞吐量的DVFS权衡 | 功耗约束 → 调度优先级 |

### 协同优化周期

```
调度算法设计
    ↓
模拟器评估硬件性能影响
    ↓
性能数据反馈调度决策
    ↓
确定硬件瓶颈与优化机会
    ↓
硬件设计调整（或明确调度的权衡）
    ↓ (反馈回第一步)
迭代优化
```

## 主要成果

### 理论贡献
- 阐述事件驱动模型在硬件-软件协同设计中的自然适用性
- 建立五层抽象（Port-Component-Connection-Pipeline-Stage），支持硬件和软件的统一建模
- 提出性能分析工具链，支持微架构级到系统级的多粒度评估
- 形式化硬件约束与调度策略的相互影响关系

### 实践贡献
- 模拟器加速硬件设计：新模型开发周期从月级降至周级
- 模拟器指导调度优化：快速评估调度策略的硬件性能影响
- 完整的工具链：支持硬件和软件的并行迭代
- 处理器建模精度：架构级建模达到95%以上

### 教学与方法论
- 演示硬件-软件协同设计的完整过程（从理论到实施）
- 提供性能建模与分析的系统方法
- 展示事件驱动在系统设计中的应用价值
- 强调约束与优化的权衡思考

## 使用本论文

### 硬件架构师
- 第一章 + 第二章：构建快速建模工具
- 第三章：理解处理器设计的折衷
- 第四章 4.1-4.3：理解调度对硬件的需求

### 系统软件工程师
- 第一章 1.2-1.5：理解事件驱动和性能监测
- 第二章 2.1-2.4：理解框架支持
- 第三章 3.1, 3.3, 3.6：理解硬件约束
- 第四章全部：设计和优化推理调度

### AI系统研究者
- 了解硬件如何影响调度性能（第三章 → 第四章 4.1-4.5）
- 理解调度如何驱动硬件需求（第四章 → 第三章）
- 掌握快速评估的工具和方法（第一章、第二章）

### 学生与教学
- 快速通道：获取协同设计的核心思想
- 硬件优先：深入学习处理器设计
- 调度优先：深入学习推理系统设计
- 全面学习：理解系统性的设计和优化

---

**总字数**: 约110,000字  
**组织结构**: 5部分（基础理论 → 框架设计 → 硬件应用 → 调度应用 → 协同方法）  
**核心特色**: 硬件-软件协同设计视角  
**最后更新**: 2024年11月

## 导航链接

### 按学习阶段
- [基础理论：事件驱动模拟](./part1-foundations/chapter1-event-driven-simulation/README.md)
- [框架设计：通用建模架构](./part2-framework/chapter2-architecture-modeling/README.md)  

### 按应用领域
- [硬件应用：Coral NPU处理器](./part3-applications/chapter3-coral-npu/README.md)
- [系统应用：LLM推理调度](./part3-applications/chapter4-llm-inference-scheduling/README.md)

### 按角色
- [硬件设计师](./part1-foundations/chapter1-event-driven-simulation/README.md) → [框架](./part2-framework/chapter2-architecture-modeling/README.md) → [硬件案例](./part3-applications/chapter3-coral-npu/README.md)
- [系统软件工程师](./part1-foundations/chapter1-event-driven-simulation/README.md) → [框架](./part2-framework/chapter2-architecture-modeling/README.md) → [调度应用](./part3-applications/chapter4-llm-inference-scheduling/README.md)
- [研究者](./part1-foundations/chapter1-event-driven-simulation/README.md) → [全部应用](./part3-applications/) → [协同方法论](./appendix/codesign-methodology.md)
