# 1.4 时间同步与多时钟域

## 1.3.1 多时钟域系统的时间管理

在现代SoC（System-on-Chip）和异构计算系统中，存在多个频率不同的时钟域是常见的。例如，处理器核心运行在2GHz，内存控制器运行在1GHz，I/O子系统运行在500MHz。这种设计提高了能效，但也给模拟带来了复杂性。

**单一全局时钟的局限**：

最直观的做法是假设整个系统运行在单一的全局时钟上。但这会带来问题：

- **频率转换**：如果某个时钟域的频率与全局时钟不同，则需要不断进行频率转换。例如，内存访问耗时"5个内存周期"需要转换为"10个处理器周期"
- **精度损失**：在频率转换过程中，可能产生舍入误差
- **可读性差**：代码中充满了频率转换因子，难以理解

**多时钟域的本质**：

在事件驱动模型中，多时钟域的本质很简单：不同的时钟域产生事件的周期不同。处理器核心每个周期产生一个Tick事件，内存控制器每隔2个处理器周期产生一个Tick事件（假设内存频率是处理器频率的一半）。事件驱动框架自然地处理了这种不同频率的事件流。

## 1.3.2 最小公倍数同步方法

对于多时钟域，一个实用的同步方法是基于最小公倍数（LCM）的同步。

**LCM同步的原理**：

假设系统中有n个时钟域，频率分别为f₁, f₂, ..., fₙ。定义：

$$\text{LCM频率} = \text{LCM}(f_1, f_2, ..., f_n)$$

$$\text{同步周期} = \frac{\text{LCM频率}}{f_i}$$

在这个同步周期内，所有时钟域的状态达到一致。例如：

- 时钟域A：2GHz
- 时钟域B：1GHz  
- 时钟域C：1.5GHz

LCM(2, 1, 1.5) = 6GHz，因此：
- 域A的同步周期：6/2 = 3个A周期
- 域B的同步周期：6/1 = 6个B周期
- 域C的同步周期：6/1.5 = 4个C周期

三个域在3个A周期（即6个B周期，4个C周期）后重新同步。

**LCM同步的优势和劣势**：

优势：
- 简单直观，易于实现
- 支持任意频率组合
- 同步点明确，便于断点设置和调试

劣势：
- 如果频率不是简单整数比（如质数比），LCM可能很大，导致同步周期过长
- 对于某些频率组合（如3GHz和7GHz），LCM是21GHz，同步周期可能非常长

## 1.3.3 时钟域相位的处理

除了频率不同外，不同时钟域的相位也可能不同。这增加了同步的复杂性。

**相位偏移的影响**：

假设处理器核心在时刻0产生第一个Tick，内存控制器在时刻100产生第一个Tick（相对延迟）。这种相位偏移会影响两个域的同步时刻。

在实际系统中，相位通常由硬件PLL（Phase-Locked Loop）控制。在模拟中，相位通常在初始化时设置，之后保持不变。

**相位补偿**：

处理相位偏移的方法是在时刻计算时加入相位偏移：

$$\text{事件时刻} = T \times \frac{\text{LCM}}{\text{频率}} + \text{相位偏移}$$

这样可以准确模拟不同相位的时钟域。

## 1.3.4 跨域通信中的时序问题

不同时钟域之间的通信必须小心处理，以避免时序错误。

**亚稳态问题**：在真实的硬件中，跨域信号的转发会引入亚稳态（Metastability），可能导致信号的不稳定。在模拟中，我们通常不模拟亚稳态，而是假设信号安全地从一个域转移到另一个域。

**同步器的延迟**：安全的跨域通信通常需要同步器电路，这会引入额外的延迟。例如，一个使用2级触发器的同步器通常会引入2-3个目标时钟周期的延迟。

在模拟中，这个延迟必须被正确建模：

```
源域事件（时刻T）
  ↓
进入同步器（延迟N个目标周期）
  ↓
目标域接收（时刻T + N×周期转换因子）
```

## 1.3.5 时钟动态调整的模拟

现代处理器支持DVFS（动态电压频率调整），允许在运行时改变时钟频率。这给模拟增加了复杂性。

**频率变化的影响**：

当时钟频率改变时，既有事件的相对时刻关系可能改变。例如：

- 假设在时刻0，处理器核心频率为2GHz
- 假设一个计算事件计划在时刻1000（500个核心周期后）
- 在时刻500（核心周期），频率动态改变为1GHz
- 现在相同的计算应该在时刻1000（核心周期）后完成，即物理时刻1500

这需要在频率改变时，重新计算所有未来事件的时刻。

**处理频率变化**：

一个实用的方法是维护两种时刻：

1. **周期时刻**（Cycle Time）：以当前时钟周期为单位
2. **物理时刻**（Physical Time）：以纳秒或其他固定单位

当频率改变时，物理时刻保持不变，但周期时刻需要重新计算。所有事件都以物理时刻存储，只在需要时进行转换。

## 小结

多时钟域的时间管理是事件驱动模拟中的关键问题。事件驱动框架的自然支持使得多时钟域比循环驱动下容易得多。基于LCM的同步是实用的解决方案，虽然有一些局限，但对大多数系统设计场景都足够。

对于复杂的系统（如频率大幅变化或多个异步时钟域），可能需要更复杂的同步机制。但核心原则保持不变：确保不同时钟域的事件按正确的全局顺序执行。

---

---

**下一节**：[1.5 性能监测与轨迹捕捉](./1.5-性能监测与轨迹捕捉.md)