# 第二章 体系结构建模方法学

## 章节概述

本章系统介绍了一套通用的体系结构建模框架。在第一章事件驱动基础上，本章提出并阐述五个核心概念：**Port(端口)**、**Component(组件)**、**Connection(连接)**、**Pipeline(流水线)**和**Stage(级)**。这套方法学提供了灵活、可复用、可扩展的体系结构建模能力。

**本章主要内容**:
- 建模框架的整体设计
- Port端口的设计与实现
- Component组件的组织方式
- Connection连接的多种通信模式
- Pipeline流水线的建模方法
- Stage级的处理模型
- 数据流与同步机制
- 生命周期管理

**本章字数**: 约28,000字

## 主要小节列表

| 小节 | 标题 | 字数 |
|------|------|------|
| 2.1 | [建模框架](./2.1-建模框架.md) | 3500 |
| 2.2 | [Port设计](./2.2-Port设计.md) | 4000 |
| 2.3 | [Component组织](./2.3-Component组织.md) | 4000 |
| 2.4 | [Connection原语](./2.4-Connection原语.md) | 4500 |
| 2.5 | [Pipeline建模](./2.5-Pipeline建模.md) | 4000 |
| 2.6 | [Stage设计](./2.6-Stage设计.md) | 3000 |
| 2.7 | [数据流与同步](./2.7-数据流与同步.md) | 3000 |

## 核心概念预览

### 五个核心抽象

本章介绍的五个核心概念形成了一个**分层的抽象模型**：

```
┌─────────────────────────────────────────────────┐
│                系统级建模                       │
│  (多个Component之间的通信与协调)               │
├─────────────────────────────────────────────────┤
│                Component层                     │
│  (独立的、可复用的体系结构单元)                 │
├──────────────┬──────────────┬──────────────────┤
│ Port层       │ Pipeline层   │ Stage层           │
│ (通信接口)   │ (流水线结构) │ (处理单元)        │
├──────────────┼──────────────┼──────────────────┤
│ Connection层 (多种通信模式)                    │
├─────────────────────────────────────────────────┤
│       事件驱动底层(Event Scheduler)             │
└─────────────────────────────────────────────────┘
```

### 概念间的关系

```
Port(端口)
  ├─ 是Component的通信接口
  ├─ 通过Connection相连
  └─ 传递DataPacket

Component(组件)
  ├─ 包含Port
  ├─ 可以是Pipeline或其他
  └─ 接收事件驱动的生命周期调用

Connection(连接)
  ├─ 连接Port对
  ├─ 实现不同的通信协议
  └─ 根据需要引入延迟或流控

Pipeline(流水线)
  ├─ 是特殊的Component
  ├─ 包含多个Stage
  └─ 管理数据流动

Stage(级)
  ├─ Pipeline的基本单元
  ├─ 实现处理函数
  └─ 不直接参与事件驱动
```

## 第二章的学习路径

### 快速入门(2小时)
1. 阅读2.1建模框架
2. 浏览2.2-2.4的概念
3. 跳转第三章看实际应用

### 深入学习(6小时)
1. 完整阅读2.1-2.7
2. 研究代码示例
3. 理解各概念的设计权衡

### 实践应用(8小时)
1. 根据2.7的数据流模型
2. 设计自己的Component
3. 实现并验证

## 关键设计原则

本章强调的设计原则：

1. **分离关切(Separation of Concerns)**
   - 通信与计算分离
   - 每个Component专注一个功能

2. **可组合性(Composability)**
   - 通过Port相连
   - 支持嵌套组合

3. **灵活性(Flexibility)**
   - 支持多种通信模式
   - 支持同步和异步操作

4. **可复用性(Reusability)**
   - Component可在不同系统中使用
   - Pipeline和Stage通用设计

5. **可扩展性(Extensibility)**
   - 支持用户自定义Component
   - 支持自定义Connection类型

## 与第一章的关系

```
第一章: 事件驱动基础
  │
  └─→ 提供时间管理和事件调度
      (EventScheduler, Event, EventQueue)
  
第二章: 建模方法学
  │
  ├─ 建立在事件驱动之上
  ├─ 为Component提供生命周期调用
  └─ 支持多种时间模型(周期驱动或事件驱动)
  
使用关系:
┌──────────────────────────────────────┐
│      用户定义的系统                  │
│  (包含多个Component通过Port相连)     │
├──────────────────────────────────────┤
│  Port ← Connection → Port             │
├──────────────────────────────────────┤
│  Component (包含Pipeline和Stage)     │
├──────────────────────────────────────┤
│  Event Scheduler (from Chapter 1)     │
└──────────────────────────────────────┘
```

## 方法学的适用范围

这套方法学适用于：

| 系统类型 | 适用度 | 备注 |
|---------|--------|------|
| 处理器/核心 | ★★★ | 最主要应用场景 |
| 缓存/内存系统 | ★★★ | 完全适用 |
| I/O子系统 | ★★★ | 适合异步事件 |
| 网络模拟 | ★★★ | 分布式系统模型 |
| 乱序执行 | ★★☆ | 需要扩展 |
| 多线程模型 | ★★☆ | 需要同步机制 |
| 栅栏和屏障 | ★☆☆ | 不太适合 |

## 关键术语预览

| 术语 | 简要说明 |
|------|---------|
| Port | Component的通信接口，分为INPUT和OUTPUT |
| Component | 可复用的体系结构基本单元 |
| Connection | 连接Port，实现通信协议 |
| Pipeline | 多级流水线结构，是特殊的Component |
| Stage | 流水线的基本处理单元 |
| DataPacket | 端口间传递的数据 |
| TickingComponent | 周期驱动的Component |
| Ready-Valid | 握手通信协议 |
| Credit Flow | 信用流控制 |

## 与第三章的关系

第二章建立的方法学在第三章中得到具体应用：

```
第二章的抽象设计
  ↓
第三章的具体应用
  ├─ Coral NPU的标量核心
  │  ├─ 使用Component建模各功能单元
  │  ├─ 使用Pipeline建模指令流水线
  │  └─ 使用Port和Connection建模互联
  │
  └─ RVV向量后端
     ├─ 使用Pipeline建模向量流水线
     ├─ 使用Component建模向量单元
     └─ 使用Connection建模向量数据路径
```

## 推荐阅读顺序

**第一次阅读** (了解整体):
1. 本导读
2. 2.1 建模框架 (理解全貌)
3. 跳转第三章看具体例子 (加深理解)
4. 回来阅读2.2-2.7 (深化细节)

**第二次阅读** (深入学习):
1. 完整阅读2.1-2.7
2. 研究代码实现
3. 思考自己的设计

**参考查阅** (解决具体问题):
1. 2.2: Port的使用问题
2. 2.3: Component的组织问题
3. 2.4: Connection的选择问题
4. 2.5: Pipeline的配置问题
5. 2.7: 数据流和同步问题

## 本章的学习成果

完成本章学习后，你应该能够：

1. **理解**体系结构模拟的关键抽象
2. **设计**自己的Component和Pipeline
3. **选择**合适的Connection协议
4. **实现**通信流控和同步
5. **组合**多个组件形成系统
6. **调试**数据流和时序问题

## 章节提纲

```
第二章: 体系结构建模方法学
├─ 2.1 建模框架 (整体视图)
├─ 2.2 Port设计 (通信接口)
├─ 2.3 Component组织 (基本单元)
├─ 2.4 Connection原语 (多种协议)
├─ 2.5 Pipeline建模 (流水线结构)
├─ 2.6 Stage设计 (处理单元)
└─ 2.7 数据流与同步 (整体机制)
```

---

**下一小节**: [2.1 建模框架](./2.1-建模框架.md)

